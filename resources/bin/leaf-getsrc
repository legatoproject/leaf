#!/bin/sh
# LEAF_DESCRIPTION source code mode toggling
set -e

getsrcHelp() {
    cat << END
usage: leaf getsrc [-h] [-v | -q] [--user | --workspace | --profile] [--disable] [SRCMODULE]

positional arguments:
  SRCMODULE      the module from which to trigger source sync
                 if not specified, list available modules

optional arguments:
  -h, --help     show this help message and exit
  -v, --verbose  increase output verbosity
  -q, --quiet    decrease output verbosity
  --user         use user configuration environment
  --workspace    use workspace environment
  --profile      use profile environment
  --disable      disable source mode and get back to binary mode
END
    exit 0
}

# Parsing options
while test -n "$1"; do
    case "$1" in
        --help)
            # Simple help page
            getsrcHelp;;
        --disable)
            # Toggling source mode off
            DISABLE_MODE="1";;
        -v|--verbose)
            # Remember verbose mode
            export LEAF_VERBOSE=1
            SYNC_OPTIONS="$SYNC_OPTIONS $1"
            FTR_OPTIONS="$FTR_OPTIONS $1";;
        -q|--quiet)
            # Remember quiet mode
            export LEAF_QUIET=1
            SYNC_OPTIONS="$SYNC_OPTIONS $1"
            FTR_OPTIONS="$FTR_OPTIONS $1";;
        *)
            # Default: requested source module
            if test -z "$LEAFSRCMODULE"; then 
                LEAFSRCMODULE="$1"; 
            else 
                # Preserve other options for leaf feature call
                FTR_OPTIONS="$FTR_OPTIONS $1"
            fi;;
    esac
    shift
done

leafCall() {
    if test -n "$LEAF_NON_INTERACTIVE"; then
        local ARGS="--non-interactive"
    fi
    \leaf $ARGS "$@"
}

if test -z "$LEAFSRCMODULE"; then
    # No source module required, just list all available ones
    leafCall feature list -q | grep -e '-src$' | sed -e 's/-src$//g'
else
    # Check current status
    QUERY_ERROR=$(mktemp)
    CURRENT_STATE=$(leafCall feature query ${LEAFSRCMODULE}-src -q 2> $QUERY_ERROR || true)
    if test -z "$CURRENT_STATE"; then
        if test "$(cat $QUERY_ERROR)" = "Cannot find feature ${LEAFSRCMODULE}-src"; then
            echo "Unknown source module: ${LEAFSRCMODULE}"
            exit 2
        else
            echo "Profile out of sync; try \`leaf profile sync\`"
            exit 3
        fi
    fi

    if test -n "$DISABLE_MODE" -a "$CURRENT_STATE" != "binary"; then
        FTR_TOGGLE="binary"    # Only switch back feature to binary if currently set to something else
    elif test -z "$DISABLE_MODE" -a "$CURRENT_STATE" = "binary"; then
        FTR_TOGGLE="source"    # Only switch feature to source, if still set to binary
    fi

    # Need to toggle?
    if test -n "$FTR_TOGGLE"; then
        leafCall feature toggle ${LEAFSRCMODULE}-src $FTR_TOGGLE $FTR_OPTIONS
    fi

    # Sync
    export LEAF_CMD=getsrc
    export LEAF_GETSRC_MODULE=${LEAFSRCMODULE}
    leafCall profile sync $SYNC_OPTIONS
fi
